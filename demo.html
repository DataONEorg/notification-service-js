<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notification Service JS Demo</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        line-height: 1.4;
        --accent: #0a7bc2;
        --border: #d0d7de;
        --bg: #f8fafc;
        --bg-panel: #ffffff;
        --text-muted: #556;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --border: #1f2933;
          --bg: #0f172a;
          --bg-panel: #111827;
          --text-muted: #94a3b8;
        }
      }

      body {
        margin: 0;
        background: var(--bg);
        color: inherit;
      }

      main {
        margin: 0 auto;
        max-width: 960px;
        padding: 2.5rem 1.5rem 4rem;
        display: grid;
        gap: 2rem;
      }

      header h1 {
        margin: 0 0 0.5rem;
        font-size: clamp(1.75rem, 2vw + 1rem, 2.5rem);
      }

      header p {
        margin: 0;
        color: var(--text-muted);
        max-width: 65ch;
      }

      .panel {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 8px 24px rgb(15 23 42 / 6%);
      }

      .panel h2 {
        margin-top: 0;
        font-size: 1.25rem;
      }

      form {
        display: grid;
        gap: 1rem;
      }

      label {
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      input,
      select,
      button,
      textarea {
        font: inherit;
      }

      input,
      select,
      textarea {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.55rem 0.75rem;
        background: transparent;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgb(10 123 194 / 25%);
      }

      button {
        cursor: pointer;
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        background: var(--accent);
        color: white;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:is(:hover, :focus-visible) {
        transform: translateY(-1px);
        box-shadow: 0 8px 14px rgb(10 123 194 / 30%);
      }

      button.secondary {
        background: transparent;
        color: inherit;
        border-color: var(--border);
        box-shadow: none;
      }

      button.secondary:is(:hover, :focus-visible) {
        border-color: var(--accent);
        box-shadow: 0 8px 14px rgb(10 123 194 / 20%);
      }

      .grid {
        display: grid;
        gap: 1.5rem;
      }

      .grid.two {
        grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
      }

      .hint {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin: 0;
      }

      .inline-fields {
        display: grid;
        gap: 0.75rem;
      }

      @media (min-width: 640px) {
        .inline-fields {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          align-items: end;
        }
      }

      #status {
        margin: 0.5rem 0 0;
        font-size: 0.95rem;
        color: var(--text-muted);
      }

      #log-output {
        display: grid;
        gap: 1rem;
        max-height: min(480px, 45vh);
        overflow: auto;
        padding-right: 0.25rem;
      }

      .log-entry {
        background: rgba(10, 123, 194, 0.1);
        border-radius: 12px;
        padding: 0.9rem 1rem 1rem;
        border: 1px solid rgba(10, 123, 194, 0.15);
      }

      .log-entry h3 {
        margin: 0 0 0.4rem;
        font-size: 1rem;
      }

      .log-entry pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
      }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        background: rgba(99, 102, 241, 0.15);
        padding: 0.08rem 0.35rem;
        border-radius: 0.35rem;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Notification Service JS Demo</h1>
        <p>
          Configure the client, then try subscribing, unsubscribing, or listing
          subscriptions for a resource.
        </p>
      </header>

      <section class="panel" aria-labelledby="configuration-heading">
        <h2 id="configuration-heading">1. Configure the client</h2>
        <form id="config-form">
          <div class="grid two">
            <label>
              API prefix URL
              <input
                id="prefix-url"
                name="prefix-url"
                type="url"
                placeholder="https://notifications.test.dataone.org/notifications"
                value="https://notifications.test.dataone.org/notifications"
                required
              />
            </label>
            <label>
              Access token
              <input
                id="access-token"
                name="access-token"
                type="text"
                placeholder="Paste a bearer token"
                value=""
              />
              <p class="hint">
                The token is read from this field right before each request via
                the <code>getToken</code>
                callback. If using
                <code>https://notifications.test.dataone.org/notifications</code
                >, you can get a test token from
                <a
                  href="https://metacat-dev.test.dataone.org/"
                  target="_blank"
                  rel="noopener noreferrer"
                  >metacat-dev.test.dataone</a
                >.
              </p>
            </label>
          </div>

          <label>
            Resource types (comma-separated)
            <input
              id="resource-types"
              name="resource-types"
              type="text"
              value="datasetChanges, citations"
              placeholder="datasetChanges, citations"
            />
            <p class="hint">
              These populate the resource type selectors below and are passed to
              the client as
              <code>resourceTypes</code>.
            </p>
          </label>

          <div class="inline-fields">
            <button type="submit">Instantiate client</button>
            <button type="button" class="secondary" id="clear-log">
              Clear log
            </button>
          </div>

          <p id="status" role="status" aria-live="polite"></p>
        </form>
      </section>

      <section class="panel" aria-labelledby="actions-heading">
        <h2 id="actions-heading">2. Try the API endpoints</h2>
        <div class="grid two">
          <form id="subscribe-form">
            <h3>Subscribe</h3>
            <label>
              PID
              <input
                id="subscribe-pid"
                type="text"
                placeholder="urn:uuid:example-pid"
                required
              />
            </label>
            <label>
              Resource type
              <select
                id="subscribe-resource"
                class="resource-type-select"
              ></select>
            </label>
            <button type="submit">Subscribe</button>
          </form>

          <form id="unsubscribe-form">
            <h3>Unsubscribe</h3>
            <label>
              PID
              <input
                id="unsubscribe-pid"
                type="text"
                placeholder="urn:uuid:example-pid"
                required
              />
            </label>
            <label>
              Resource type
              <select
                id="unsubscribe-resource"
                class="resource-type-select"
              ></select>
            </label>
            <button type="submit">Unsubscribe</button>
          </form>
        </div>

        <form id="list-form">
          <h3>List subscriptions</h3>
          <label>
            Resource type
            <select id="list-resource" class="resource-type-select"></select>
          </label>
          <button type="submit">Fetch subscriptions</button>
        </form>
      </section>

      <section class="panel" aria-labelledby="log-heading">
        <h2 id="log-heading">3. Inspect responses</h2>
        <p class="hint">
          Requests rely on your network environment and token. Any thrown error
          is logged below so you can see what the client received from the
          service.
        </p>
        <div id="log-output" aria-live="polite" aria-label="Activity log"></div>
      </section>

      <section class="panel" aria-labelledby="tips-heading">
        <h2 id="tips-heading">Implementation notes</h2>
        <details open>
          <summary>How this demo uses the library</summary>
          <ul>
            <li>
              A single <code>NotificationService</code> instance is created
              after you submit the configuration form.
            </li>
            <li>
              <code>getToken</code> is a promise-returning callback that reads
              the token input. In production, you can pass in a method that
              fetches a fresh token from the dataone token endpoint.
            </li>
            <li>
              <code>validatePID</code> is a simple async check that ensures the
              PID input is not empty. In the future, we could replace it with
              verification that the resource type matches the format ID of the
              object.
            </li>
            <li>
              Each form handler awaits the client call and pushes either the
              JSON response (if any) or the thrown error into the log viewer.
            </li>
          </ul>
        </details>
      </section>
    </main>

    <!-- temporary, until we bundle the package together -->
    <script type="importmap">
      {
        "imports": {
          "ky": "/node_modules/ky/distribution/index.js"
        }
      }
    </script>

    <script type="module">
      import NotificationService from "/src/API.js";

      const DEFAULT_RESOURCE_TYPES = ["datasetChanges", "citations"];

      const configForm = document.getElementById("config-form");
      const prefixInput = document.getElementById("prefix-url");
      const tokenInput = document.getElementById("access-token");
      const resourceTypesInput = document.getElementById("resource-types");
      const status = document.getElementById("status");
      const logOutput = document.getElementById("log-output");

      const subscribeForm = document.getElementById("subscribe-form");
      const unsubscribeForm = document.getElementById("unsubscribe-form");
      const listForm = document.getElementById("list-form");

      const subscribePidInput = document.getElementById("subscribe-pid");
      const unsubscribePidInput = document.getElementById("unsubscribe-pid");

      const subscribeResourceSelect =
        document.getElementById("subscribe-resource");
      const unsubscribeResourceSelect = document.getElementById(
        "unsubscribe-resource"
      );
      const listResourceSelect = document.getElementById("list-resource");
      const resourceSelects = [
        subscribeResourceSelect,
        unsubscribeResourceSelect,
        listResourceSelect,
      ];

      const clearLogButton = document.getElementById("clear-log");

      let client = null;

      const formatResourceTypes = (rawValue) =>
        Array.from(
          new Set(
            (rawValue || "")
              .split(",")
              .map((type) => type.trim())
              .filter(Boolean)
          )
        );

      const updateResourceTypeOptions = (types) => {
        resourceSelects.forEach((select) => {
          select.innerHTML = "";
          types.forEach((type) => {
            const option = document.createElement("option");
            option.value = type;
            option.textContent = type;
            select.appendChild(option);
          });
        });
      };

      updateResourceTypeOptions(DEFAULT_RESOURCE_TYPES);

      const showButtonLoading = (button) => {
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.textContent = "Loading...";
      };

      const hideButtonLoading = (button) => {
        button.disabled = false;
        if (button.dataset.originalText) {
          button.textContent = button.dataset.originalText;
          delete button.dataset.originalText;
        }
      };

      const timestamp = () =>
        new Date().toLocaleTimeString(undefined, {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const log = (label, payload, isError = false) => {
        const wrapper = document.createElement("article");
        wrapper.className = "log-entry";

        const title = document.createElement("h3");
        title.textContent = `${timestamp()} Â· ${label}`;
        wrapper.appendChild(title);

        const pre = document.createElement("pre");
        if (payload === undefined) {
          pre.textContent = "No response body";
        } else if (payload instanceof Error) {
          pre.textContent = `${payload.name}: ${payload.message}`;
          if (payload.response) {
            pre.textContent += `\nStatus: ${payload.response.status}`;
          }
        } else if (typeof payload === "string") {
          pre.textContent = payload;
        } else {
          try {
            pre.textContent = JSON.stringify(payload, null, 2);
          } catch {
            pre.textContent = String(payload);
          }
        }

        if (isError) {
          const red = "rgba(239, 68, 68, ";
          wrapper.style.background = `${red}0.12)`;
          wrapper.style.borderColor = `${red}0.35)`;
        }

        wrapper.appendChild(pre);
        logOutput.prepend(wrapper);
      };

      configForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const prefixUrl = prefixInput.value.trim();
        if (!prefixUrl) {
          status.textContent = "Please provide a valid API prefix URL.";
          return;
        }

        const resourceTypes = formatResourceTypes(resourceTypesInput.value);
        const typesToUse = resourceTypes.length
          ? resourceTypes
          : DEFAULT_RESOURCE_TYPES;
        updateResourceTypeOptions(typesToUse);

        try {
          client = new NotificationService({
            prefixUrl,
            getToken: async () => tokenInput.value.trim(),
            resourceTypes: typesToUse,
            validatePID: async (pid) => pid.trim().length > 0,
          });
          status.textContent = `Client ready. Prefix set to ${prefixUrl.replace(
            /\/+$/,
            ""
          )}`;
          log("Client configured", { prefixUrl, resourceTypes: typesToUse });
        } catch (error) {
          client = null;
          console.log(error);
          status.textContent = error.message;
          log("Client configuration failed", error, true);
        }
      });

      const ensureClient = () => {
        if (!client) {
          console.log("NO CLIENT!");

          status.textContent =
            "Instantiate the client first using the configuration form.";
          return false;
        }
        return true;
      };

      subscribeForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureClient()) return;

        const pid = subscribePidInput.value.trim();
        const resourceType = subscribeResourceSelect.value;

        try {
          const response = await client.subscribe(pid, resourceType, {
            hooks: {
              beforeRequest: [
                (request) => {
                  const btn = subscribeForm.querySelector(
                    "button[type=submit]"
                  );
                  showButtonLoading(btn);
                  console.log("Prepared request:", request);
                  return request;
                },
              ],
              afterResponse: [
                async (request, _options, response) => {
                  console.log("Raw response:", response);
                  const btn = subscribeForm.querySelector(
                    "button[type=submit]"
                  );
                  hideButtonLoading(btn);
                  return response;
                },
              ],
            },
          });
          log(
            "Subscribe succeeded",
            response ?? "Subscription request accepted"
          );
        } catch (error) {
          console.log(error);
          log("Subscribe failed", error, true);
        }
      });

      unsubscribeForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureClient()) return;

        const pid = unsubscribePidInput.value.trim();
        const resourceType = unsubscribeResourceSelect.value;

        try {
          await client.unsubscribe(pid, resourceType, {
            hooks: {
              beforeRequest: [
                (request) => {
                  const btn = unsubscribeForm.querySelector(
                    "button[type=submit]"
                  );
                  showButtonLoading(btn);
                  console.log("Prepared request:", request);
                  return request;
                },
              ],
              afterResponse: [
                async (request, _options, response) => {
                  console.log("Raw response:", response);
                  const btn = unsubscribeForm.querySelector(
                    "button[type=submit]"
                  );
                  hideButtonLoading(btn);
                  return response;
                },
              ],
            },
          });
          log(
            "Unsubscribe succeeded",
            "Subscription removed (no body returned)"
          );
        } catch (error) {
          console.log(error);
          log("Unsubscribe failed", error, true);
        }
      });

      listForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!ensureClient()) return;

        const resourceType = listResourceSelect.value;
        try {
          const subscriptions = await client.getSubscriptions(resourceType, {
            hooks: {
              beforeRequest: [
                (request) => {
                  const btn = listForm.querySelector("button[type=submit]");
                  showButtonLoading(btn);
                  console.log("Prepared request:", request);
                  return request;
                },
              ],
              afterResponse: [
                async (request, _options, response) => {
                  console.log("Raw response:", response);
                  const btn = listForm.querySelector("button[type=submit]");
                  hideButtonLoading(btn);
                  return response;
                },
              ],
            },
          });
          log(
            "Fetched subscriptions",
            subscriptions ?? "No subscriptions returned"
          );
        } catch (error) {
          console.log(error);
          log("List failed", error, true);
        }
      });

      clearLogButton.addEventListener("click", () => {
        logOutput.innerHTML = "";
        status.textContent = "Log cleared.";
      });
    </script>
  </body>
</html>
